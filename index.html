<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Drive Integration</title>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
    <h1>Google Drive Integration</h1>

    <!-- Button to Sign in and connect to Google Drive -->
    <button id="authorize-button" style="display: block;">Connect to Google Drive</button>
    <button id="signout-button" style="display: none;">Sign Out</button>

    <!-- Display Status -->
    <div id="status"></div>

    <!-- Upload Sales Data to Google Drive -->
    <button id="upload-button" style="display: none;">Upload Sales Data</button>

    <script>
        const CLIENT_ID = '444696366439-fp0342q1a6siel3uo7boecnrh44i9p7v.apps.googleusercontent.com';
        const API_KEY = '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';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        // Load Google API
        function handleClientLoad() {
            gapi.load('client:auth2', initClient);
        }

        // Initialize the Google API client library
        function initClient() {
            gapi.client.init({
                apiKey: API_KEY,
                clientId: CLIENT_ID,
                discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
                scope: SCOPES
            }).then(() => {
                // Update UI based on user's sign-in state
                const authorizeButton = document.getElementById('authorize-button');
                const signoutButton = document.getElementById('signout-button');
                const uploadButton = document.getElementById('upload-button');

                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());

                authorizeButton.onclick = handleAuthClick;
                signoutButton.onclick = handleSignoutClick;
                uploadButton.onclick = uploadSalesData;
            });
        }

        // Update UI based on sign-in status
        function updateSigninStatus(isSignedIn) {
            const authorizeButton = document.getElementById('authorize-button');
            const signoutButton = document.getElementById('signout-button');
            const uploadButton = document.getElementById('upload-button');
            const statusDiv = document.getElementById('status');

            if (isSignedIn) {
                authorizeButton.style.display = 'none';
                signoutButton.style.display = 'block';
                uploadButton.style.display = 'block';
                statusDiv.innerHTML = '<p>Connected to Google Drive</p>';
            } else {
                authorizeButton.style.display = 'block';
                signoutButton.style.display = 'none';
                uploadButton.style.display = 'none';
                statusDiv.innerHTML = '<p>Please connect to Google Drive to upload data.</p>';
            }
        }

        // Handle sign-in button click
        function handleAuthClick(event) {
            gapi.auth2.getAuthInstance().signIn();
        }

        // Handle sign-out button click
        function handleSignoutClick(event) {
            gapi.auth2.getAuthInstance().signOut();
        }

        // Upload sales data to Google Drive
        function uploadSalesData() {
            const salesData = JSON.parse(localStorage.getItem("salesData")) || [];
            const fileContent = JSON.stringify(salesData, null, 2);
            const blob = new Blob([fileContent], { type: 'application/json' });

            const metadata = {
                name: 'SalesData.json',
                mimeType: 'application/json'
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', blob);

            fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + gapi.auth.getToken().access_token
                },
                body: form
            })
                .then(response => response.json())
                .then(data => {
                    alert('Sales data uploaded to Google Drive successfully!');
                })
                .catch(error => {
                    console.error('Error uploading file:', error);
                    alert('Failed to upload sales data.');
                });
        }

        // Load the API client
        handleClientLoad();
    </script>
</body>
</html>
